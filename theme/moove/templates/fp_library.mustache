{{>theme_moove/inc_start}}
    <div id="page" class="container-fluid">
    	<div class="mt-2">
        {{^hasportal}}
            {{{ output.full_header }}}
        {{/hasportal}}
    	</div>
        <div id="page-content" class="row">
            <div id="region-main-box" class="col-12">
                {{#hasregionmainsettingsmenu}}
                    <div id="region-main-settings-menu" class="d-print-none">
                        <div> {{{ output.region_main_settings_menu }}} </div>
                    </div>
                {{/hasregionmainsettingsmenu}}
                <section id="region-main">
                    {{#canviewlibrarymanagement}}
                    <div class="card mb-3">
                        <div class="card-body">
                            {{#reportdata}}
                                <div class="row">
                                    <div class="col-xl-3 col-lg-6 col-sm-6 col-xs-12 mb-3">
                                        <div class="card text-white card-dashboard-library">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <div class="mb-2 font-weight-bold">
                                                            {{access}}
                                                        </div>
                                                        <a class="cl-cursor" data-action="viewcourse">
                                                            Lượt truy cập thư viện
                                                        </a>
                                                    </div>
                                                    <div>
                                                        <i class="fa fa-line-chart mr-3 db-icon-font-size">
                                                        </i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-xl-3 col-lg-6 col-sm-6 col-xs-12 mb-3">
                                        <div class="card text-white card-dashboard-library">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <div class="mb-2 font-weight-bold">
                                                            {{folder}}
                                                        </div>
                                                        <a class="cl-cursor" data-action="viewstudent">
                                                            Tổng thư mục
                                                        </a>
                                                    </div>
                                                    <div>
                                                        <i class="fa fa-folder-open mr-3 db-icon-font-size"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-xl-3 col-lg-6 col-sm-6 col-xs-12 mb-3">
                                        <div class="card text-white card-dashboard-library" style=";">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <div class="mb-2 font-weight-bold">
                                                            {{module}}
                                                        </div>
                                                        <a class="cl-cursor" data-action="viewmodule">
                                                            Tổng tài liệu thư viện
                                                        </a>
                                                    </div>
                                                    <div>
                                                        <i class="fa fa-file mr-3 db-icon-font-size"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-xl-3 col-lg-6 col-sm-6 col-xs-12 mb-3">
                                        <div class="card text-white card-dashboard-library">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <div class="mb-2 font-weight-bold">
                                                            {{moduleapproval}}
                                                        </div>
                                                        <a class="cl-cursor" data-action="viewexam">
                                                            Tài liệu yêu cầu duyệt
                                                        </a>
                                                    </div>
                                                    <div>
                                                        <img src="/./theme/moove/pix/addfile.svg" class="db-icon" style="width: 50px;height: 50px">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {{/reportdata}}
                            <div class="row">
                                <div class="col-md-6 col-xs-12">
                                    <div style="margin-left: -6px;margin-right: -6px;">
                                        <div class="title-db-library d-flex justify-content-between">
                                            <h3>Thống kê lượt truy cập thư viện</h3>
                                            <h3 id="last-access" style="color: white"></h3>
                                        </div>
                                        <hr>
                                        <div id="access-chart"></div>
                                    </div>
                                </div>
                                <div class="col-md-6 col-xs-12">
                                    <div style="margin-left: -6px;margin-right: -6px;">
                                        <div class="title-db-library d-flex justify-content-between">
                                            <h3>{{#str}} listapproval,local_newsvnr{{/str}}</h3>
                                            <div class="approvalmodule color-white cursor-pointer" style="font-size: 11px"><i class="fa fa-arrows-alt" aria-hidden="true"></i></div>
                                        </div>
                                        <div id="library-approval-module-db">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {{/canviewlibrarymanagement}}
                    {{^canviewlibrarymanagement}}
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex mb-3">
                                <a class="btn btn-secondary mr-2 request-module-fuction disabled" id="request_approval" href="javascript:;">{{#str}} requestapproval,local_newsvnr{{/str}}</a>
                                <a class="btn btn-secondary mr-2 request-module-fuction disabled" id="delete_module_request" href="javascript:;">{{#str}} delete,local_newsvnr{{/str}}</a>
                            </div>
                            <div class="title-db-library d-flex justify-content-between">
                                <h3>{{#str}} listapproval,local_newsvnr{{/str}}</h3>
                            </div>
                            <div id="library-request-approval"></div>
                        </div>
                    </div>
                    {{/canviewlibrarymanagement}}
                    <div class="card">
                        <div class="card-body d-none">
                            {{{ output.main_content }}}
                        </div>
		                    <div class="card-body library">
			                    <div class="row">
			                        <div class="col-12 col-md-3">
                                        <div class="row-card">
                      
				                        	<div id="folder_library">
				                        		<div class="folder-tree-replace">
				                       			  {{{output.library_folder_custom}}}
				                       			</div>
				                       			<!-- popup thêm thư mục mới -->
				                       			{{#canedit}}
			  									<div class="popup-setting">
			  										<ul>
			  										</ul>
			  									</div> 
			  									{{/canedit}}
				                       		</div>
                                        </div>
			                        </div>
			                        <div class="col-12 col-md-9">
                                        <div class="row-card">
                                            <ul class="nav-tabs nav multi-tab" tab="searchlibrary">
                                                <li class="nav-item"><a href="javascript:void(0)" class="nav-link active" data-key="keywork">{{#str}}searchbyname, local_newsvnr{{/str}}</a></li>
                                                <li class="nav-item"><a href="javascript:void(0)" class="nav-link" data-key="content">{{#str}}searchbycontent, local_newsvnr{{/str}}</a></li>
                                            </ul>
                                            <div class="tab-content" tab="searchlibrary">
                                                <div data="keywork" class="tab-pane active">
                                                    <div class="example mb-2" >
                                                        <input class="searchlibrary" folderid="0" type="text" searchtype="searchname" placeholder="{{#str}}searchresourcename, local_newsvnr{{/str}}"><button class="library"><i class="fa fa-search"></i></button>
                                                    </div>
                                                </div>
                                                <div data="content" class="tab-pane">
                                                    <div class="example mb-2" >
                                                        <input class="searchlibrary" folderid="0" type="text" searchtype="searchcontent" placeholder="{{#str}}searchcontentname, local_newsvnr{{/str}}"><button class="library"><i class="fa fa-search library"></i></button>
                                                    </div>
                                                </div>
                                            </div>
				                       		<div id="file_library">
				                       			<div class="top-library full-flex">
				                       				<div id="header-library">
				                       				</div>
                                                    {{#canaddresource}}
                                                        <div class="cursor-pointer" data-toggle="modal" data-target="#add-popup-modal-module"><i class="fa fa-plus mr-2" aria-hidden="true"></i>Đưa tài nguyên lên hệ thống</div>
                                                    {{/canaddresource}}
												</div>
												<div class="overflow-auto">
													<table class="table" >
										 				<thead>
										 					<tr>
										 					<th scope="col">{{#str}}name, local_newsvnr{{/str}}</th>
										 					<th scope="col">{{#str}}type, local_newsvnr{{/str}}</th>
															<th scope="col">{{#str}}size, local_newsvnr{{/str}}</th>
										 					<th scope="col" class="sort-module cursor-pointer" action="timesort_desc">{{#str}}timecreated, local_newsvnr{{/str}}</th>
										 					<th scope="col">{{#str}}author, local_newsvnr{{/str}}</th>
                                                            <th scope="col" class="sort-module cursor-pointer" action="viewsort_desc">{{#str}}viewed, local_newsvnr{{/str}}</th>
										 					<th scope="col">{{#str}}function, local_newsvnr{{/str}}</th>
										 				    </tr>
														</thead>
														 <div class="loading-page"></div>
														<tbody id="table-library">
														</tbody>
													</table>
												</div>
												<div class="col-md-12 mb-2" id="pagination"></div>
												<div class="alert-warning" role="alert"></div>
				                       		</div>
                                        </div>
			                       </div>
			                    </div>
                                <div id="viewApprovalModule">
			               			<div id="library-approval-module">
			               			</div>
                                    {{#canedit}}
			               			<div class="d-flex mt-3">
								        <button type="button" class="btn btn-primary mr-2" id="delete-module-select"><i class="fa fa-trash mr-2" aria-hidden="true"></i>{{#str}}deletecheck, local_newsvnr{{/str}}</button>
								    	<button type="button" class="btn btn-primary" id="approval-module-select"><i class="fa fa-check mr-2" aria-hidden="true"></i>{{#str}}approvalcheck, local_newsvnr{{/str}}</button>
								   </div>
                                   {{/canedit}}
                                </div>
		               		</div>
                		</div>
                    </div>
                </section>
            </div>
        </div>
    </div>
    <!-- popup thêm thư mục mới -->
    <div class="modal modal-library" id="add-popup-modal-folder">
		<div class="modal-dialog">
			<!-- Modal content-->
			<div class="modal-content">
				<div class="modal-header">
				    <h4 class="modal-title">{{#str}}addfolder, local_newsvnr{{/str}}</h4>
				    <button type="button" class="close" data-dismiss="modal">&times;</button>
				</div>
				<div class="modal-body add-folder-popup">
				    <div class="form-group">
						<label class="mb-1" for="email">{{#str}}foldername, local_newsvnr{{/str}}:</label>
						<input autocomplete="off" class="form-control form_input_validate" id="foldername" required>
                        <div class="foldernamevalidate mt-1"></div>
					</div>
                    <div class="form-check">
                        <input class="form-check-input folderdefault" type="checkbox" value="" onchange="defaultFolder()" checked>
                        <label class="form-check-label mb-2" for="folderdefault">
                            {{#str}}defaultfolder, local_newsvnr{{/str}}
                        </label>
                    </div>
					<div class="form-group">
						<label class="mb-1" for="pwd">{{#str}}folderparent, local_newsvnr{{/str}}:</label>
						<input autocomplete="off" data-role="tagsinput" class="form-control folderparent" onclick="viewTree();">
						<div class="tree-view-folder">
							{{{output.library_folder}}}
						</div>
					</div>
					<div class="form-group">
						<label class="mb-1" for="pwd">{{#str}}description, local_newsvnr{{/str}}:</label>
						<textarea autocomplete="off" class="form-control" id="folderdes"></textarea>
					</div>
                    <div class="form-group">
                        <label class="mb-1" for="pwd">{{#str}}positionviewfolder, local_newsvnr{{/str}}:</label>
                        <select id="positionpermission" multiple="multiple" data-placeholder="{{#str}}selectposition, local_newsvnr{{/str}}"></select>
                    </div>
				</div>
				<div class="modal-footer">
				    <button type="button" class="btn btn-primary" action="add" id="add-new-folder">{{#str}}createfolder, local_newsvnr{{/str}}</button>
				    <button type="button" class="btn btn-danger" data-dismiss="modal" id="cancel-popup">{{#str}}cancel, local_newsvnr{{/str}}</button>
				</div>
			</div>
		</div>
    </div>
    <!-- popup chỉnh sửa thư mục -->
    <div id="edit-popup-modal-folder"></div>
    <!-- popup thêm module -->
    <div class="modal modal-library" id="add-popup-modal-module">
		<div class="modal-dialog">
			<!-- Modal content-->
			<div class="modal-content">
				<div class="modal-header">
				    <h4 class="modal-title">{{#str}}addresource, local_newsvnr{{/str}}</h4>
				    <button type="button" class="close" data-dismiss="modal">&times;</button>
				</div>
				<div class="modal-body add-module-popup">
					{{#module}}
					<div class="option">
						   <input type="radio" name="selectmodule" id="item_url" value="{{value}}">
                                {{# pix }} icon, {{moduleicon}} {{/ pix }}
                                <span class="typename">{{modulename}}</span>
                    </div>
                    {{/module}} 
				</div>
				<div class="modal-footer">
				    <button type="button" class="btn btn-primary" action="add" id="add-new-module">{{#str}}createresource, local_newsvnr{{/str}}</button>
				    <button type="button" class="btn btn-danger" data-dismiss="modal" id="cancel-popup">{{#str}}cancel, local_newsvnr{{/str}}</button>
				</div>
			</div>
		</div>
    </div>
    <!-- popup nhúng iframe -->
    <div class="modal fade modal-viewfile" id="modal-iframe-library" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      	<div class="modal-dialog modal-fluid" role="document">
		    <div class="modal-iframe modal-content">
		      <div class="modal-header">
		        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
		          <span aria-hidden="true">&times;</span>
		        </button>
		      </div>
		      <div class="modal-body pt-0">
		      	<iframe width='100%' height='700px'></iframe>
		      </div>
		    </div>
  		</div>
	</div>
	{{! popup chia sẻ module từ thư viện sang khóa học }}
	<div class="modal modal-share-module" id="share-popup-modal-module">
		<div class="modal-dialog">
			<!-- Modal content-->
			<div class="modal-content">
				<div class="modal-header">
				    <h4 class="modal-title">{{#str}}librarytocourse, local_newsvnr{{/str}}</h4>
				    <button type="button" class="close" data-dismiss="modal">&times;</button>
				</div>
				<div class="modal-body">
					<p class="font-bold mb-1 mt-2">{{#str}}course, local_newsvnr{{/str}}</p>
        			<div class="w-100" id="course-share-input"></div>
				 	<p class="font-bold mb-1 mt-2">{{#str}}coursesection, local_newsvnr{{/str}}</p>
        			<div class="w-100" id="course-section-input"></div>
				</div>
				<div class="modal-footer">
				    <button type="button" class="btn btn-primary" id="share-module-library">{{#str}}add, local_newsvnr{{/str}}</button>
				    <button type="button" class="btn btn-danger" data-dismiss="modal" id="cancel-popup">{{#str}}cancel, local_newsvnr{{/str}}</button>
				</div>
			</div>
		</div>
    </div>
{{>theme_moove/inc_end}}
<script type="text/javascript">
    $('.folderparent').focus(function(e) {
        $(this).blur();
    });
    // nhúng iframe mở module trang thư viện
    const iFrameLibrary = (url,moduletype) => {
        require(['jquery', 'core/config'], ($, config) => {
            setCookie('cookie', 'focusmod');
            $('#modal-iframe-library iframe').replaceWith('<iframe height="800px" src="'+url+'" width="100%"></iframe>');
            $('#modal-iframe-library').modal();
        })
    }
    //Cập nhật thư mục 
    const updateFolder = (folderid) => {
        require(['jquery', 'core/config', 'alertjs'], ($, Config, alertify) => {
            var script = Config.wwwroot + "/local/newsvnr/ajax/library_online/library_folder_ajax.php";
            var foldername = $('.edit-folder-popup #foldername').val();
            var parentid = $('.edit-folder-popup .folderparent').attr('parentid');
            var folderdes = $('.edit-folder-popup #folderdes').val();
            var action =  $('#edit-folder-popup').attr('action');
            var multiselect = $("#edit-positionpermission").data("kendoMultiSelect")
            var listposition = multiselect.value();
            var data = JSON.stringify(listposition);
            var settings = {
                type: "GET",
                processData: true,
                data: {
                    foldername: foldername,
                    folderid: folderid,
                    parentid: parentid,
                    folderdes: folderdes,
                    action: action,
                    listposition: data

                },
                contenttype: "application/json"
            }
            if(foldername == '') {
                alertify.alert('Alert Title', 'Alert Message!');
                return;
            }
            $.ajax(script, settings).then(function(response) {
                $('#edit-popup-modal-folder').modal('hide');
                var obj = $.parseJSON(response);
                alertify.notify(obj.alert,'success',3);
                location.reload();
            })

        });
    };	
    //Lấy thông tin thư mục cha thư viện trực tuyến
    const getParentValue = (id,name) => {
        require(['jquery', 'core/config'], ($, Config) => {
            $(".folderdefault").prop("checked", false);
            $('.tree-view-folder li').removeClass('active');
            $('.tree-view-folder li.'+id).addClass('active');
            $('.tree-view-folder .content-expand.'+id).slideToggle();
            var link = get_link_folder(id,name)
            $('input.folderparent').val(link);
            $('input.folderparent').attr('parentid', id);
        })
    }
    // Mở cây thư mục thư viện trực tuyến
    const viewTree = () => {
        require(['jquery', 'core/config'], ($, Config) => {
            $('.tree-view-folder').slideDown();
        })
    }
    // Xóa,ẩn hiện module trên thư viện 
    const actionModule = (moduleid,action,folderid) => {
        require(['jquery', 'core/config', 'alertjs' ], ($, Config,alertify) => {
            var script = Config.wwwroot + "/local/newsvnr/ajax/library_online/library_approval_module_ajax.php";
            var scriptmodule = Config.wwwroot + "/local/newsvnr/ajax/library_online/library_module_ajax.php?folderid="+folderid;
            var settings = {
                type: "GET",
                processData: true,
                data: {
                    moduleid: moduleid, 
                    action:action
                },
                contenttype: "application/json"
            }
            if(action == 'delete') {
                alertify.confirm('{{#str}} alert, local_newsvnr {{/str}}', '{{#str}} deleteconfirm, local_newsvnr{{/str}}', 
                    function() { 
                        $('.loading-page').addClass('active');
                        $.ajax(script, settings).then(function(response) {
                            $.getJSON(scriptmodule, function(data) {
                                $('#table-library').hide().html(data.result).fadeIn('fast');
                                $('#header-library').replaceWith(data.header);
                                $('#pagination').replaceWith(data.pagination);
                            })
                            $('.loading-page').removeClass('active');
                            alertify.notify('{{#str}} delete , local_newsvnr{{/str}}','success',3);
                        })
                    },
                    function() { return });
            }
            else {
                $('.loading-page').addClass('active');
                $.ajax(script, settings).then(function(response) {
                    $.getJSON(scriptmodule, function(data) {
                        $('#table-library').hide().html(data.result).fadeIn('fast');
                        $('#header-library').replaceWith(data.header);
                        $('#pagination').replaceWith(data.pagination);
                        $('.loading-page').removeClass('active');
                    })
                })
            }
        })
    }
    // Lấy đường dẫn thư mục trong thư viện
    function get_link_folder(id,name) { 
        if(typeof id == 'undefined') {
            return name;
        } else {
            var idparent = $('li.folder.'+id).parent('ul').prev('li').attr('id');
            var val = $('li.folder.'+id).parent('ul').prev('li').first().text()
            var name = val + ' / ' + name;
            return get_link_folder(idparent,name);
        }
    }
    // Xóa , sửa , thêm thư mục con (action popup)
    const actionPopupLibrary = (folderid,foldername,action) => {
        require(['jquery', 'core/config', 'alertjs','local_newsvnr/initkendogrid'], ($, Config, alertify, kendo) => {
            var script = Config.wwwroot + "/local/newsvnr/ajax/library_online/library_folder_ajax.php";
            var scriptpermit = Config.wwwroot + '/local/newsvnr/ajax/library_online/library_permission.php';
            // Xử lý thêm thư mục con
            var kendosettings = {
                url: scriptpermit,
                type: 'GET',
                dataType: "json",
                contentType: 'application/json; charset=utf-8',
                data: {
                    action: 'get_position',
                }
            };
            if (action == 'addchildfolder') {
                var val = get_link_folder(folderid, foldername);
                $('input.folderparent').val(val);
                $('input.folderparent').attr('parentid', folderid);
                $('#add-popup-modal-folder').on('shown.bs.modal');
                $(".folderdefault").prop("checked", false);
                return;
            }
            var settings = {
                type: "GET",
                processData: true,
                data: {
                    folderid: folderid,
                    foldername: foldername,
                    action: action
                },
                contenttype: "application/json",
            }
            $.ajax(script, settings).then(function(response) {
                var obj = $.parseJSON(response);
                if(action == 'edit') {
                    $('#edit-popup-modal-folder').replaceWith(obj.result);
                    $('#edit-popup-modal-folder').modal('show');
                    $("#edit-positionpermission").kendoMultiSelect({
                        dataTextField: "positionname",
                        dataValueField: "positionid",
                        dataSource: {
                                transport: {
                                    read: kendosettings
                                },
                            },
                        value: obj.positionpermisson
                    });
                } 
                if(action == 'hide' || action == 'show') {
                    $('.tree-folder li.folder.'+folderid).toggleClass('show');
                    $('.tree-folder li.folder.'+folderid).toggleClass('hide');
                    $('ul.'+folderid).toggleClass('hide');
                    if(action == 'hide') {
                        $('.tree-folder li.folder.'+folderid).append('<i class="fa fa-eye-slash" aria-hidden="true"></i>');
                    } else {
                        $('.tree-folder li.folder.'+folderid+' i.fa-eye-slash').remove();
                    }
                    alertify.notify(obj.alert,'success',3);
                }
                if(action == 'delete') {
                    $('.tree-folder li.folder.'+folderid).remove();
                    $('ul.'+folderid).remove();
                    alertify.notify(obj.alert,'success',3);
                }
            })
        })
    }
    // Lọc theo loại module thư viện
    const filterModule = (moduletype,folderid) => {
        require(['jquery', 'core/config'], ($, Config) => {
            $('.sort-module i').remove();
            var script = Config.wwwroot + "/local/newsvnr/ajax/library_online/library_module_ajax.php";
            $('.loading-page').addClass('active');
            var settings = {
                type: "GET",
                processData: true,
                data: {
                    modulefilter: moduletype,
                    folderid: folderid
                },
                contenttype: "application/json"
            }
            $.ajax(script, settings).then(function(response) {
                var obj = $.parseJSON(response);
                $('#header-library').replaceWith(obj.header);
                $('#table-library').hide().html(obj.result).fadeIn('fast');
                $('#pagination').replaceWith(obj.pagination);
                $('.loading-page').removeClass('active');
            })
        })
    }
    // Yêu cầu / hủy yêu cầu duyệt tài liệu
    const requestApprovalModule = (moduleid,action) => {
        require(['jquery', 'core/config', 'alertjs'], ($, Config, alertify) => {
            var script = Config.wwwroot + "/local/newsvnr/ajax/library_online/library_approval_module_ajax.php";
            var settings = {
                type: "GET",
                processData: true,
                data: {
                    action: action,
                    moduleid: moduleid
                },
                contenttype: "application/json"
            }
            $.ajax(script, settings).then(function(response) {
                var obj = $.parseJSON(response);
                alertify.notify(obj.message, 'success', 3);
                var grid = $('#library-request-approval').data("kendoGrid");
                grid.dataSource.read();
            })
        })
    }
    // defaultFolder
    const defaultFolder = () => {
        require(['jquery', 'core/config'], ($, Config) => {
            if($('.folderdefault').is(":checked")) {
                $('.folderparent').val('');
                $('.folderparent').attr('parentid','0');
            } 
        })
    }
</script>
{{#js}}
require(['jquery','core/config', 'local_newsvnr/initkendogrid','alertjs','core/str'],function($, Config, kendo, alertify, Str) {
    var scriptpermit = Config.wwwroot + '/local/newsvnr/ajax/library_online/library_permission.php';
    var settings = {
            url: scriptpermit,
            type: 'GET',
            dataType: "json",
            contentType: 'application/json; charset=utf-8',
            data: {
                action: 'get_position',
            }
        };
    $("#positionpermission").kendoMultiSelect({
        dataTextField: "positionname",
        dataValueField: "positionid",
        dataSource: {
                transport: {
                    read: settings
                },
            },
    });
})
{{/js}}