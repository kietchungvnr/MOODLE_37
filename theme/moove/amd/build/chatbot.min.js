define(["jquery", "core/config", "core/str", "core/notification"], function($, Config, Str, Notification) {
    "use strict";

    var lastUserMessage = '';
    var getUserMessage = '';
    var SELECTOR = {
        SECLECTHELPBOX: '.help-content-chatbot li',
        SELECTTAGHELP: '.tag-chatbot',
        SUGGESTIONTAGSBOX: '.bot-caption',
        BOTRESPONSEWAIT: '#response-animation',
        KEYUPINPUTMESSAGE: 'input[name=send-message]',
        CHATBOTICON: '#chatbot-icon',
        CHATBOTCHAT: '#chatbot-chat',
        BUTTONCLOSEBOXCHAT: '.tpl-close',
        BUTTONIMAGESENDMSG: '.send-icon path',
        BUTTONSENDMSG: '#send-message',
    };

    var mainScript = Config.wwwroot;
    var settings, script;

    $(document).ready(function() {
        $(SELECTOR.CHATBOTICON).click(function(){
            $(this).animate({bottom: '-55px'});
            $(this).slideToggle();
            $(SELECTOR.CHATBOTCHAT).slideToggle();
        });
        $(SELECTOR.BUTTONCLOSEBOXCHAT).click(function(){
            $(SELECTOR.CHATBOTICON).animate({bottom: '55px'});
            $(SELECTOR.CHATBOTCHAT).slideToggle();
            $(SELECTOR.CHATBOTICON).slideToggle();
        });
        $(SELECTOR.KEYUPINPUTMESSAGE).keyup(function() {
            $(SELECTOR.BUTTONIMAGESENDMSG).attr('fill', '#006cff');
            if($(SELECTOR.KEYUPINPUTMESSAGE).val() == '') {
                $(SELECTOR.BUTTONIMAGESENDMSG).attr('fill', '#d7d7d7');
            }
        });
    });

    const wait = ms => {
        return new Promise(res => setTimeout(res, ms));
    };

    $.urlParam = function(name){
        var urlUserID = $('.text-username').attr('href');
        var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(urlUserID);
        if (results==null) {
           return null;
        }
        return decodeURI(results[1]) || 0;
    }

    function getUserId() {
        return $.urlParam('id');
    }

    function helpSendMessageHTML(text) {
        var html = '<div class="help-chat"><div class="tpl-text-response-wrapper" data-type="help"><div class="tpl-text-response"><ul class="list-group"><div class="help-content-chatbot"><li class="list-group-item">Xem danh s√°ch kh√≥a h·ªçc</li><li class="list-group-item">Xem danh s√°ch s√°ch kh√≥a gi·∫£ng</li><li class="list-group-item">Xem danh s√°ch s√°ch ƒëi·ªÉm c·ªßa c√°c kh√≥a h·ªçc</li><li class="list-group-item">Xem s·ª± ki·ªán s·∫Øp h·∫øt h·∫°n</li><li class="list-group-item">Xem kh√≥a h·ªçc s·∫Øp h·∫øt h·∫°n</li></div></ul></div></div></div></div>';
        return html;
    }

    function userSendMessageHTML(text) {
        var html = '<div class="user-chat"><div class="user-response-wrapper"><div class="tpl-text-response-wrapper" data-type="user"><div class="tpl-text-response">' + text + '</div></div></div></div>';
        return html;
    }

    function botResponseHTML(text) {
        var html = '<div class="bot-chat"><div class="user-response-wrapper"><div class="tpl-text-response-wrapper" data-type="bot"><div class="tpl-text-response">' + text + '</div></div></div></div>';
        return html;
    }

    function botSpinerResponseHTML() {
        var html = '<div class="bot-chat" id="response-animation"><div class="user-response-wrapper"><div class="tpl-text-response-wrapper" data-type="bot"><div class="tpl-text-response"><span class="spinme-left"><div class="spinner"><div class="bounce1"></div><div class="bounce2"></div><div class="bounce3"></div></div></span></div></div></div></div>';
        return html;
    }

    function enterMessageHtmlToChatBox(text) {
        $('.main-conversation-chatbot').append(text);
    }

    function showHelpOptions(text) {
        var helpBoxHTML = helpSendMessageHTML(text);
        // enterMessageHtmlToChatBox(helpSendMessageHTML(helpSendMessageHTML));
        return  helpBoxHTML;
    }

    function autoScrollBottom() {
        $('.conversation-chatbot').animate({scrollTop: document.body.scrollHeight},"fast");
    }

    function selectHelpOptions(element) {
        $(element).click(function() {
            // lastUserMessage = userSendMessageHTML($(this).text());
            lastUserMessage = $(this).text();
            enterMessageHtmlToChatBox(userSendMessageHTML($(this).text()));
            chatbotResponse(lastUserMessage).then(res => {
                $(SELECTOR.BOTRESPONSEWAIT).replaceWith(enterMessageHtmlToChatBox(res));
                // enterMessageHtmlToChatBox(res);
                autoScrollBottom();
            });
            
        });
    }

    var callAjax = (script, settings) => {
        var botMessage = '';
        return $.ajax(script, settings)
        .then((resp) => {
            var fullName = resp.data[0].user;
            var msg = 'Xin ch√†o ' + fullName + ', t√¥i l√† con BOT "ngu". Hi Hi';
            botMessage = botResponseHTML(msg);
            return Promise.resolve(botMessage);
        });
    }
    
    function selectTagHelp(element) {
        $(element).click(function() {
            $(SELECTOR.SUGGESTIONTAGSBOX).fadeOut();
            lastUserMessage = $(this).text();
            enterMessageHtmlToChatBox(userSendMessageHTML(lastUserMessage));
            chatbotResponse(lastUserMessage).then(res => {
                enterMessageHtmlToChatBox(res);
                selectHelpOptions(SELECTOR.SECLECTHELPBOX);
                autoScrollBottom();
            });
            
        });
    }


    function chatbotResponse(text) {
        var userId = parseInt(getUserId());
        var botMessage = '';
        switch(text) {
            case 'ch√†o':
                enterMessageHtmlToChatBox(botSpinerResponseHTML());
                settings = {
                        type:"POST",
                        data:{
                            userid : userId
                        },
                        contenttype:"application/json",
                    };
                script = mainScript + '/local/newsvnr/api/chatbot/hello';
                return callAjax(script, settings);
            case 'hi':
                botMessage = botResponseHTML('·ªú hi üòä');
                break;
            case 'Xem danh s√°ch kh√≥a h·ªçc':
                botMessage = botResponseHTML('·ªú hi 2 üòä');
                break;
            case 'Help':
                var helpMessage = botResponseHTML('T√¥i l√† con BOT ngu n√™n ch·ªâ ch·ªçn c√°c l·ª±a ch·ªçn d∆∞·ªõi ƒë√¢y nha!');
                enterMessageHtmlToChatBox(helpMessage);
                botMessage = showHelpOptions(botMessage);
                break;
            case 'tags':
                $(SELECTOR.SUGGESTIONTAGSBOX).fadeIn();
                return Promise.resolve();
            default:
                botMessage = botResponseHTML('empty');
        }   
        return Promise.resolve(botMessage); 
    }

    function userSendMessage() {
        if($(SELECTOR.BUTTONSENDMSG).val() != "") {
            lastUserMessage = $(SELECTOR.BUTTONSENDMSG).val();
            // $(SELECTOR.BUTTONSENDMSG).attr('value', '');
            // $(SELECTOR.BUTTONSENDMSG).attr('placeholder', 'Type your message here');
            document.getElementById('send-message').value = '';
            document.getElementById('send-message').placeholder = 'Type your message here';
            enterMessageHtmlToChatBox(userSendMessageHTML(lastUserMessage));
            chatbotResponse(lastUserMessage).then(res => {
                $(SELECTOR.BOTRESPONSEWAIT).replaceWith(enterMessageHtmlToChatBox(res));
                if(lastUserMessage == 'Help') {
                    selectHelpOptions(SELECTOR.SECLECTHELPBOX);
                }
                autoScrollBottom();
            });
        }
    }
    
    
    function keyPress(e) {
        var x = e || window.event;
        var key = (x.keyCode || x.which);
        if (key == 13 || key == 3) {
            userSendMessage();
            $(SELECTOR.KEYUPINPUTMESSAGE).keyup(function() {
                $(SELECTOR.BUTTONIMAGESENDMSG).attr('fill', '#d7d7d7');
            });
        }
        if (key == 38){
            console.log('hi')
        }
    }

    selectTagHelp(SELECTOR.SELECTTAGHELP);

    document.onkeypress = keyPress;



});