define(["jquery","core/str","core/modal_factory","core/modal_events","core/templates","core/notification","core/ajax","core/fragment","kendo.all.min","alertjs","core/config"],function(e,t,o,n,s,i,a,r,l,d,c){var h="#formactionid",u="input.usercheckbox",m="input.usercheckbox[value='0']",p="input.usercheckbox:checked",g="#participantsform",f="#checkall",b="#checkallnos",v="#checkallonpage",_="#checknone",y=function(e){this.courseId=e.courseid,this.noteStateNames=e.noteStateNames,this.stateHelpIcon=e.stateHelpIcon,this.attachEventListeners()};function k(e){return new Promise(t=>{setTimeout(t,e)})}return y.prototype.modal=null,y.prototype.courseId=-1,y.prototype.noteStateNames={},y.prototype.stateHelpIcon="",y.prototype.getBody=function(e){void 0===e&&(e={});var t={jsonformdata:JSON.stringify(e)};return r.loadFragment("local_newsvnr","send_email_form",1,t).catch(i.exception)},y.prototype.handleFormSubmissionResponse=function(){this.modal.hide(),this.initKendo(),Y.use("moodle-core-formchangechecker",function(){M.core_formchangechecker.reset_form_dirty_state()}),e("body").removeClass("loading"),d.success(M.util.get_string("sendingsuccess","local_newsvnr"),"success",1)},y.prototype.handleFormSubmissionFailure=function(e){this.modal.setBody(this.getBody(e)),k(2e3).then(e=>{this.initKendo()})},y.prototype.submitFormAjax=function(t){t.preventDefault(),e("body").addClass("loading");var o=this.modal.getRoot().find("form").serialize(),n=e("#list-userid").val(),s=e("#enrolusersbutton-1 input[name=id]").val();o=o+"&users="+encodeURI(n)+"&courseid="+encodeURI(s),a.call([{methodname:"local_newsvnr_submit_send_email_form",args:{contextid:1,jsonformdata:JSON.stringify(o)},done:this.handleFormSubmissionResponse.bind(this,o),fail:this.handleFormSubmissionFailure.bind(this,o)}])},y.prototype.submitForm=function(e){e.preventDefault(),this.modal.getRoot().find("form").submit()},y.prototype.initKendo=function(t){var o=c.wwwroot+"/local/newsvnr/ajax/email/emailmanagement.php";e.ajax(o,{type:"GET",dataType:"json",contentType:"application/json; charset=utf-8",data:{action:"get_emailtype"}}).then(function(t){e("#email-type").kendoDropDownList({dataSource:t,dataTextField:"text",dataValueField:"value",change:function(t){var n={type:"GET",dataType:"json",contentType:"application/json; charset=utf-8",data:{action:"get_emailcontent",templateid:this.value()}};e.ajax(o,n).then(function(t){e("#id_subject").val(t.subject),e("#id_content_editoreditable").html(t.content),e("#id_content_editoreditable").focus()})}})})},y.prototype.showSendEmail=function(t){return e.when(o.create({type:o.types.SAVE_CANCEL,title:M.util.get_string("sendemail","local_newsvnr"),body:this.getBody()})).then(function(e,o){return this.modal=e,this.modal.setSaveButtonText(M.util.get_string("sendemail","local_newsvnr")),this.modal.setLarge(),this.modal.getRoot().on(n.hidden,function(){this.modal.getRoot().remove()}.bind(this)),this.modal.getRoot().on(n.shown,function(){var e='<input class="d-none" id="list-userid" value="'+t+'">';this.modal.getRoot().append(e),this.modal.getRoot().append("<style>[data-fieldtype=submit] { display: none ! important; }</style>")}.bind(this)),this.modal.getRoot().on(n.save,this.submitForm.bind(this)),this.modal.getRoot().on("submit","form",this.submitFormAjax.bind(this)),this.modal.show(),this.modal}.bind(this))},y.prototype.attachEventListeners=function(){e(h).on("change",function(t){var o=e(t.target).val();if(-1!==o.indexOf("#")){t.preventDefault();var n=[];if(e(p).each(function(t,o){var s=e(o).attr("name").replace("user","");n.push(s)}),n.length<1)return d.warning(M.util.get_string("pleasepickuser","local_newsvnr"),"warning",3),void e(h+' option[value=""]').prop("selected","selected");"#messageselect"==o?this.showSendMessage(n).fail(i.exception):"#sendemail"==o?this.showSendEmail(n).then(e=>{k(2e3).then(t=>{this.initKendo(e)})}):"#addgroupnote"==o&&this.showAddNote(n).fail(i.exception),e(h+' option[value=""]').prop("selected","selected")}else""!==o&&(e(p).length>0?e(g).submit():e(h+' option[value=""]').prop("selected","selected"))}.bind(this)),e(f).on("click",function(){var t=e(this).data("showallink");t&&(window.location=t)}),e(b).on("click",function(){e(m).prop("checked",!0)}),e(v).on("click",function(){e(u).prop("checked",!0)}),e(_).on("click",function(){e(u).prop("checked",!1)})},y.prototype.showAddNote=function(i){if(0==i.length)return e.Deferred().resolve().promise();var a=[];for(var r in this.noteStateNames)switch(r){case"draft":a.push({value:"personal",label:this.noteStateNames[r]});break;case"public":a.push({value:"course",label:this.noteStateNames[r],selected:1});break;case"site":a.push({value:r,label:this.noteStateNames[r]})}var l={stateNames:a,stateHelpIcon:this.stateHelpIcon},d=null;return d=1==i.length?t.get_string("addbulknotesingle","core_notes"):t.get_string("addbulknote","core_notes",i.length),e.when(o.create({type:o.types.SAVE_CANCEL,body:s.render("core_user/add_bulk_note",l)}),d).then(function(t,o){return this.modal=t,this.modal.setTitle(o),this.modal.setSaveButtonText(o),this.modal.getRoot().on(n.hidden,function(){var t=e("#user-notifications [role=alert]");t.length?t.focus():e(h).focus(),this.modal.getRoot().remove()}.bind(this)),this.modal.getRoot().on(n.save,this.submitAddNote.bind(this,i)),this.modal.show(),this.modal}.bind(this))},y.prototype.submitAddNote=function(e){var o=this.modal.getRoot().find("form textarea").val(),n=this.modal.getRoot().find("form select").val(),s=[],r=0;for(r=0;r<e.length;r++)s.push({userid:e[r],text:o,courseid:this.courseId,publishstate:n});return a.call([{methodname:"core_notes_create_notes",args:{notes:s}}])[0].then(function(e){return 1==e.length?t.get_string("addbulknotedonesingle","core_notes"):t.get_string("addbulknotedone","core_notes",e.length)}).then(function(e){return i.addNotification({message:e,type:"success"}),!0}).catch(i.exception)},y.prototype.showSendMessage=function(i){if(0==i.length)return e.Deferred().resolve().promise();var a=null;return a=1==i.length?t.get_string("sendbulkmessagesingle","core_message"):t.get_string("sendbulkmessage","core_message",i.length),e.when(o.create({type:o.types.SAVE_CANCEL,body:s.render("core_user/send_bulk_message",{})}),a).then(function(t,o){return this.modal=t,this.modal.setTitle(o),this.modal.setSaveButtonText(o),this.modal.getRoot().on(n.hidden,function(){e(h).focus(),this.modal.getRoot().remove()}.bind(this)),this.modal.getRoot().on(n.save,this.submitSendMessage.bind(this,i)),this.modal.show(),this.modal}.bind(this))},y.prototype.submitSendMessage=function(e){var o=this.modal.getRoot().find("form textarea").val(),n=[],s=0;for(s=0;s<e.length;s++)n.push({touserid:e[s],text:o});return a.call([{methodname:"core_message_send_instant_messages",args:{messages:n}}])[0].then(function(e){return 1==e.length?t.get_string("sendbulkmessagesentsingle","core_message"):t.get_string("sendbulkmessagesent","core_message",e.length)}).then(function(e){return i.addNotification({message:e,type:"success"}),!0}).catch(i.exception)},{init:function(e){return new y(e)}}});