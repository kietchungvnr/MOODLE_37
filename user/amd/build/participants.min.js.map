{"version":3,"sources":["../src/participants.js"],"names":["Selectors","bulkActionSelect","bulkUserSelectedCheckBoxes","checkCountButton","showCountText","showCountToggle","stateHelpIcon","tableForm","uniqueId","init","uniqueid","noteStateNames","root","document","querySelector","getTableFromUniqueId","DynamicTableSelectors","main","fromRegionId","registerEventListeners","CustomEvents","define","events","accessibleChange","on","e","target","closest","action","value","tableRoot","checkboxes","querySelectorAll","pendingPromise","Pending","indexOf","preventDefault","ids","forEach","checkbox","push","getAttribute","replace","bulkAction","then","modal","dataset","courseId","pendingBulkAction","getRoot","ModalEvents","hidden","focus","resolve","catch","Notification","exception","length","form","submit","resetBulkAction","addEventListener","showCountLink","showCountLinkClicked","contains","checkCountButtonClicked","DynamicTable","setPageSize","targetPageSize","CheckboxToggleAll","setGroupState","Events","tableContentRefreshed","defaultPageSize","parseInt","tableDefaultPerPage","currentPageSize","tablePageSize","totalRowCount","tableTotalRows","updateSlavesFromMasterState","pageCountStrings","key","component","param","classList","add","remove","Str","get_strings","showingParticipantCountString","showCountString","selectCountString","showingParticipantCount","innerHTML"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Some UI stuff for participants page.\r\n * This is also used by the report/participants/index.php because it has the same functionality.\r\n *\r\n * @module     core_user/participants\r\n * @package    core_user\r\n * @copyright  2017 Damyon Wiese\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport * as DynamicTable from 'core_table/dynamic';\r\nimport * as Str from 'core/str';\r\nimport CheckboxToggleAll from 'core/checkbox-toggleall';\r\nimport CustomEvents from 'core/custom_interaction_events';\r\nimport DynamicTableSelectors from 'core_table/local/dynamic/selectors';\r\nimport ModalEvents from 'core/modal_events';\r\nimport Notification from 'core/notification';\r\nimport Pending from 'core/pending';\r\nimport jQuery from 'jquery';\r\nimport {showAddNote, showSendMessage, showSendEmail} from 'core_user/local/participants/bulkactions';\r\n\r\nconst Selectors = {\r\n    bulkActionSelect: \"#formactionid\",\r\n    bulkUserSelectedCheckBoxes: \"input[data-togglegroup='participants-table'][data-toggle='slave']:checked\",\r\n    checkCountButton: \"#checkall\",\r\n    showCountText: '[data-region=\"participant-count\"]',\r\n    showCountToggle: '[data-action=\"showcount\"]',\r\n    stateHelpIcon: '[data-region=\"state-help-icon\"]',\r\n    tableForm: uniqueId => `form[data-table-unique-id=\"${uniqueId}\"]`,\r\n};\r\n\r\nexport const init = ({\r\n    uniqueid,\r\n    noteStateNames = {},\r\n}) => {\r\n    const root = document.querySelector(Selectors.tableForm(uniqueid));\r\n    const getTableFromUniqueId = uniqueId => root.querySelector(DynamicTableSelectors.main.fromRegionId(uniqueId));\r\n\r\n    /**\r\n     * Private method.\r\n     *\r\n     * @method registerEventListeners\r\n     * @private\r\n     */\r\n    const registerEventListeners = () => {\r\n        CustomEvents.define(Selectors.bulkActionSelect, [CustomEvents.events.accessibleChange]);\r\n        jQuery(Selectors.bulkActionSelect).on(CustomEvents.events.accessibleChange, e => {\r\n            const bulkActionSelect = e.target.closest('select');\r\n            const action = bulkActionSelect.value;\r\n            const tableRoot = getTableFromUniqueId(uniqueid);\r\n            const checkboxes = tableRoot.querySelectorAll(Selectors.bulkUserSelectedCheckBoxes);\r\n            const pendingPromise = new Pending('core_user/participants:bulkActionSelect');\r\n\r\n            if (action.indexOf('#') !== -1) {\r\n                e.preventDefault();\r\n\r\n                const ids = [];\r\n                checkboxes.forEach(checkbox => {\r\n                    ids.push(checkbox.getAttribute('name').replace('user', ''));\r\n                });\r\n\r\n                let bulkAction;\r\n                if (action === '#messageselect') {\r\n                    bulkAction = showSendMessage(ids);\r\n                } else if (action == '#sendemail') {\r\n                    bulkAction = showSendEmail(ids).then(modal => {\r\n                        return modal;\r\n                    });\r\n                } else if (action === '#addgroupnote') {\r\n                    bulkAction = showAddNote(\r\n                        root.dataset.courseId,\r\n                        ids,\r\n                        noteStateNames,\r\n                        root.querySelector(Selectors.stateHelpIcon)\r\n                    );\r\n                }\r\n\r\n                if (bulkAction) {\r\n                    const pendingBulkAction = new Pending('core_user/participants:bulkActionSelected');\r\n                    bulkAction\r\n                    .then(modal => {\r\n                        modal.getRoot().on(ModalEvents.hidden, () => {\r\n                            // Focus on the action select when the dialog is closed.\r\n                            bulkActionSelect.focus();\r\n                        });\r\n\r\n                        pendingBulkAction.resolve();\r\n                        return modal;\r\n                    })\r\n                    .catch(Notification.exception);\r\n                }\r\n            } else if (action !== '' && checkboxes.length) {\r\n                bulkActionSelect.form.submit();\r\n            }\r\n\r\n            resetBulkAction(bulkActionSelect);\r\n            pendingPromise.resolve();\r\n        });\r\n\r\n        root.addEventListener('click', e => {\r\n            // Handle clicking of the \"Show [all|count]\" and \"Select all\" actions.\r\n            const showCountLink = root.querySelector(Selectors.showCountToggle);\r\n            const checkCountButton = root.querySelector(Selectors.checkCountButton);\r\n\r\n            const showCountLinkClicked = showCountLink && showCountLink.contains(e.target);\r\n            const checkCountButtonClicked = checkCountButton && checkCountButton.contains(e.target);\r\n\r\n            if (showCountLinkClicked || checkCountButtonClicked) {\r\n                e.preventDefault();\r\n\r\n                const tableRoot = getTableFromUniqueId(uniqueid);\r\n\r\n                DynamicTable.setPageSize(tableRoot, showCountLink.dataset.targetPageSize)\r\n                .then(tableRoot => {\r\n                    // Always update the toggle state.\r\n                    // This ensures that the bulk actions are disabled after changing the page size.\r\n                    CheckboxToggleAll.setGroupState(tableRoot, 'participants-table', checkCountButtonClicked);\r\n\r\n                    return tableRoot;\r\n                })\r\n                .catch(Notification.exception);\r\n            }\r\n        });\r\n\r\n        // When the content is refreshed, update the row counts in various places.\r\n        root.addEventListener(DynamicTable.Events.tableContentRefreshed, e => {\r\n            const showCountLink = root.querySelector(Selectors.showCountToggle);\r\n            const checkCountButton = root.querySelector(Selectors.checkCountButton);\r\n\r\n            const tableRoot = e.target;\r\n\r\n            const defaultPageSize = parseInt(root.dataset.tableDefaultPerPage, 10);\r\n            const currentPageSize = parseInt(tableRoot.dataset.tablePageSize, 10);\r\n            const totalRowCount = parseInt(tableRoot.dataset.tableTotalRows, 10);\r\n\r\n            CheckboxToggleAll.updateSlavesFromMasterState(tableRoot, 'participants-table');\r\n\r\n            const pageCountStrings = [\r\n                {\r\n                    key: 'countparticipantsfound',\r\n                    component: 'core_user',\r\n                    param: totalRowCount,\r\n                },\r\n            ];\r\n\r\n\r\n            if (totalRowCount <= defaultPageSize) {\r\n                // There are fewer than the default page count numbers of rows.\r\n                showCountLink.classList.add('hidden');\r\n\r\n                if (checkCountButton) {\r\n                    checkCountButton.classList.add('hidden');\r\n                }\r\n            } else if (totalRowCount <= currentPageSize) {\r\n                // The are fewer than the current page size.\r\n                pageCountStrings.push({\r\n                    key: 'showperpage',\r\n                    component: 'core',\r\n                    param: defaultPageSize,\r\n                });\r\n\r\n                pageCountStrings.push({\r\n                    key: 'selectalluserswithcount',\r\n                    component: 'core',\r\n                    param: defaultPageSize,\r\n                });\r\n\r\n                // Show the 'Show [x]' link.\r\n                showCountLink.classList.remove('hidden');\r\n                showCountLink.dataset.targetPageSize = defaultPageSize;\r\n\r\n                if (checkCountButton) {\r\n                    // The 'Check all [x]' button is only visible when there are values to set.\r\n                    checkCountButton.classList.add('hidden');\r\n                }\r\n            } else {\r\n                pageCountStrings.push({\r\n                    key: 'showall',\r\n                    component: 'core',\r\n                    param: totalRowCount,\r\n                });\r\n\r\n                pageCountStrings.push({\r\n                    key: 'selectalluserswithcount',\r\n                    component: 'core',\r\n                    param: totalRowCount,\r\n                });\r\n\r\n                // Show both the 'Show [x]' link, and the 'Check all [x]' button.\r\n                showCountLink.classList.remove('hidden');\r\n                showCountLink.dataset.targetPageSize = totalRowCount;\r\n\r\n                if (checkCountButton) {\r\n                    checkCountButton.classList.remove('hidden');\r\n                }\r\n            }\r\n\r\n            Str.get_strings(pageCountStrings)\r\n            .then(([showingParticipantCountString, showCountString, selectCountString]) => {\r\n                const showingParticipantCount = root.querySelector(Selectors.showCountText);\r\n                showingParticipantCount.innerHTML = showingParticipantCountString;\r\n\r\n                if (showCountString) {\r\n                    showCountLink.innerHTML = showCountString;\r\n                }\r\n\r\n                if (selectCountString && checkCountButton) {\r\n                    checkCountButton.value = selectCountString;\r\n                }\r\n\r\n                return;\r\n            })\r\n            .catch(Notification.exception);\r\n        });\r\n    };\r\n\r\n    const resetBulkAction = bulkActionSelect => {\r\n        bulkActionSelect.value = '';\r\n    };\r\n\r\n    registerEventListeners();\r\n};\r\n"],"file":"participants.min.js"}