define(["jquery","core/config","validatefm","local_newsvnr/initkendogrid","alertjs","core/str","kendo.all.min","local_newsvnr/initkendocontrolservices"],function(e,t,r,i,n,s,o,a){"use strict";let l="#user_report",c={},u=t.wwwroot+"/local/newsvnr/report/ajax/userreport.php",d=t.wwwroot+"/local/newsvnr/report/ajax/userreport_action.php";var p=function(t){var r={url:u,type:"GET",dataType:"json",contentType:"application/json; charset=utf-8",data:t},n=[{template:function(e){return e.useravatar+"<a href='"+e.href+"' target='_blank'>"+e.name+"</a>"},field:"name",title:M.util.get_string("studentname","local_newsvnr"),width:"130px"},{field:"shortname",title:M.util.get_string("codeuser","local_newsvnr"),width:"100px"},{field:"username",title:M.util.get_string("username_login","local_newsvnr"),width:"100px"},{field:"email",title:M.util.get_string("email","local_newsvnr"),width:"130px"},{field:"timecreated",title:M.util.get_string("createdtime","local_newsvnr"),width:"120px"},{field:"timeaccess",title:M.util.get_string("timeaccess","local_newsvnr"),width:"100px"},{field:"lastaccess",title:M.util.get_string("lastaccess","local_newsvnr"),width:"100px"}];c.onChange=function(){e.map(this.select(),function(t){return e(t).text()}).length>0?e(".user-report-fuction").removeClass("disabled"):e(".user-report-fuction").addClass("disabled")},c.toolbar=["excel"],c.excel={fileName:"userreport.xlsx",allPages:!0},c.columns=n,c.apiSettings=r,c.deleteUserEvent=function(t){e(l).data("kendoGrid").dataSource.read()},c.hideUserEvent=function(t){e(l).data("kendoGrid").dataSource.read()},c.showUserEvent=function(t){e(l).data("kendoGrid").dataSource.read()},c.editUserEvent=function(e){};var s=i.initGrid(c);e(l).data("kendoGrid")&&e(l).data("kendoGrid").destroy(),e(".user-report-fuction").addClass("disabled"),e(l).kendoGrid(s)};return{init:function(){p(),e("#searchaccount").click(function(){!function(e,t,r,i,n,s){p({action:"searchaccount",username:e,useremail:t,usercode:r,userstatus:i,notaccess:n,notmodify:s})}(e("#username").val(),e("#useremail").val(),e("#usercode").val(),e("#userstatus").val(),e("#isnotaccess").is(":checked"),e("#isnotmodify").is(":checked"))}),e("#searchorgs").click(function(){!function(e,t){p({action:"searchorgstructure",orgstructureid:e,positionid:t})}(e("#orgstructure").val(),e("#orgstructure_position").val())}),e("#searchadvance").click(function(){var t=e("#system_role").val(),r=e("#course_role").val(),i=e("#list_course").val(),n=e("#start_timeaccess").val(),s=parseInt((new Date(n).getTime()/1e3).toFixed(0)),o=e("#end_timeaccess").val();!function(e,t,r,i,n,s){p({action:"searchadvance",systemroleid:e,courseroleid:t,courseid:r,datestart:i,dateend:n,divisionid:s})}(t,r,i,s,parseInt((new Date(o).getTime()/1e3).toFixed(0)),e("#list_division").val())}),e("#resettable").click(function(){e("#username").val(""),e("#useremail").val(""),e("#usercode").val(""),e("#isnotaccess").prop("checked",!1),e("#isnotmodify").prop("checked",!1),e("#userstatus").data("kendoDropDownList").value(-1),e("#system_role").data("kendoDropDownList").value(-1),e("#course_role").data("kendoDropDownList").value(-1),e("#list_course").data("kendoDropDownList").value(-1),e("#start_timeaccess").val(""),e("#end_timeaccess").val(""),p()}),e("#exporttable").on("click",function(t){var r=e(l).find("tr");if(e(r).find(":checkbox").is(":checked")){var i=[{cells:[{value:M.util.get_string("studentname","local_newsvnr")},{value:M.util.get_string("codeuser","local_newsvnr")},{value:M.util.get_string("username_login","local_newsvnr")},{value:M.util.get_string("email","local_newsvnr")},{value:M.util.get_string("createdtime","local_newsvnr")},{value:M.util.get_string("timeaccess","local_newsvnr")},{value:M.util.get_string("lastaccess","local_newsvnr")}]}];exportExcelKendo(l,i)}else e(".k-grid-excel").click()})},deleteUser:function(){e("#btn-user-delete").click(function(){for(var t=getSelectRow("#user_report"),r=JSON.stringify(t),i="",s=0;s<t.length;s++)i+=t[s].name+",";var o={type:"POST",processData:!0,data:{dataselect:r,action:"deleteselected"}};n.confirm("Cảnh báo","Bạn có chắc muốn xóa "+i.slice(0,-1)+" khỏi danh sách người dùng ?",function(){e.ajax(d,o).then(function(t){var r=e.parseJSON(t);n.notify(r.result,"success",3),p(),e(".user-report-fuction").addClass("disabled")})},function(){}).set("labels",{ok:M.util.get_string("yes","local_newsvnr"),cancel:M.util.get_string("no","local_newsvnr")})})},openPopUp:function(){e(".user-report-fuction").click(function(){setCookie("spa","true");var t=e(this).attr("data-href");if(null!=t){var r=e(this).text(),i=getSelectRow("#user_report"),n={type:"POST",processData:!0,data:{dataselect:JSON.stringify(i),action:"addsession"}};e.ajax(d,n).then(function(i){var n='<iframe id="iframe-edit-category" src="'+t+'" width="100%" height="600px" style="border:0"></iframe>';e("#popup-user-report .modal-title").text(r),e("#popup-user-report .modal-body").html(n),e("#iframe-edit-category").on("load",function(){iFrameResize({log:!1},"#iframe-edit-category")})})}}),e("#popup-user-report").on("hidden.bs.modal",function(){setCookie("spa","false")})},kendoDropdown:function(){var t="/local/newsvnr/report/ajax/report_data.php?action=";(u={}).apiSettings={url:t+"get_userstatus"},u.value="value",u.optionLabel=M.util.get_string("selectstatus","local_newsvnr");var r=a.initDropDownList(u);e("#userstatus").kendoDropDownList(r),(u={}).apiSettings={url:t+"get_orgstructure_category"},u.value="categoryid",u.optionLabel=M.util.get_string("selectorgstructuretype","local_newsvnr");var i=a.initDropDownList(u);e("#orgstructure_category").kendoDropDownList(i),(u={}).apiSettings={url:t+"get_orgstructure"},u.value="orgid",u.optionLabel=M.util.get_string("selectorgstructure","local_newsvnr"),u.cascadeFrom="orgstructure_category";var n=a.initDropDownList(u);e("#orgstructure").kendoDropDownList(n),(u={}).apiSettings={url:t+"get_orgstructure_jobtitle"},u.value="jobtitleid",u.optionLabel=M.util.get_string("selectjobtitle","local_newsvnr");var s=a.initDropDownList(u);e("#orgstructure_jobtitle").kendoDropDownList(s),(u={}).apiSettings={url:t+"get_orgstructure_position"},u.value="positionid",u.optionLabel=M.util.get_string("selectjobposition","local_newsvnr"),u.cascadeFrom="orgstructure_jobtitle";var o=a.initDropDownList(u);e("#orgstructure_position").kendoDropDownList(o),(u={}).apiSettings={url:t+"get_system_role"},u.value="value",u.optionLabel=M.util.get_string("selectrole","local_newsvnr");var l=a.initDropDownList(u);e("#system_role").kendoDropDownList(l),(u={}).apiSettings={url:t+"get_course_role"},u.value="value",u.optionLabel=M.util.get_string("selectrole","local_newsvnr");var c=a.initDropDownList(u);e("#course_role").kendoDropDownList(c),(u={}).apiSettings={url:t+"get_course"},u.value="id",u.optionLabel=M.util.get_string("selectcourse","local_newsvnr");var u,d=a.initDropDownList(u);e("#list_course").kendoDropDownList(d),(u={}).apiSettings={url:t+"get_division"},u.value="id",u.optionLabel=M.util.get_string("selectdivision","local_newsvnr");var p=a.initDropDownList(u);e("#list_division").kendoDropDownList(p),e("#start_timeaccess").kendoDatePicker({change:function(){e("#end_timeaccess").val("");var t=e("#start_timeaccess").val().split("/");if(t.length>1){var r=e("#end_timeaccess").data("kendoDatePicker"),i=parseInt(t[2]),n=parseInt(t[0]),s=parseInt(t[1]);r.setOptions({min:new Date(i,n-1,s+1)})}}}),e("#end_timeaccess").kendoDatePicker()}}});