define(["jquery","core/config","validatefm","local_newsvnr/initkendogrid","alertjs","core/str","kendo.all.min","local_newsvnr/initkendocontrolservices"],function(e,t,r,o,a,i,n,s){"use strict";let l="#user_report",c={},u=t.wwwroot+"/local/newsvnr/report/ajax/userreport.php",d=t.wwwroot+"/local/newsvnr/report/ajax/userreport_action.php";setCookie("cookie","focusmod"),setCookie("spa","true");var p=function(t){var r={url:u,type:"GET",dataType:"json",contentType:"application/json; charset=utf-8",data:t},a=[{template:function(e){return e.useravatar+"<a href='"+e.href+"' target='_blank'>"+e.name+"</a>"},field:"name",title:M.util.get_string("studentname","local_newsvnr"),width:"130px"},{field:"shortname",title:M.util.get_string("codeuser","local_newsvnr"),width:"100px"},{field:"username",title:M.util.get_string("username_login","local_newsvnr"),width:"100px"},{field:"email",title:M.util.get_string("email","local_newsvnr"),width:"130px"},{field:"timecreated",title:M.util.get_string("createdtime","local_newsvnr"),width:"120px"},{field:"timeaccess",title:M.util.get_string("timeaccess","local_newsvnr"),width:"100px"},{field:"lastaccess",title:M.util.get_string("lastaccess","local_newsvnr"),width:"100px"}];c.onChange=function(){e.map(this.select(),function(t){return e(t).text()}).length>0?e(".user-report-fuction").removeClass("disabled"):e(".user-report-fuction").addClass("disabled")},c.toolbar=["excel"],c.excel={fileName:"userreport.xlsx",allPages:!0},c.columns=a,c.apiSettings=r,c.deleteUserEvent=function(t){e(l).data("kendoGrid").dataSource.read()},c.hideUserEvent=function(t){e(l).data("kendoGrid").dataSource.read()},c.showUserEvent=function(t){e(l).data("kendoGrid").dataSource.read()},c.editUserEvent=function(e){};var i=o.initGrid(c);e(l).data("kendoGrid")&&e(l).data("kendoGrid").destroy(),e(".user-report-fuction").addClass("disabled"),e(l).kendoGrid(i)};return{init:function(){p(),e("#searchaccount").click(function(){!function(e,t,r,o,a,i){p({action:"searchaccount",username:e,useremail:t,usercode:r,userstatus:o,notaccess:a,notmodify:i})}(e("#username").val(),e("#useremail").val(),e("#usercode").val(),e("#userstatus").val(),e("#isnotaccess").is(":checked"),e("#isnotmodify").is(":checked"))}),e("#searchorgs").click(function(){!function(e,t){p({action:"searchorgstructure",orgstructureid:e,positionid:t})}(e("#orgstructure").val(),e("#orgstructure_position").val())}),e("#searchadvance").click(function(){var t=e("#system_role").val(),r=e("#course_role").val(),o=e("#list_course").val(),a=e("#start_timeaccess").val(),i=parseInt((new Date(a).getTime()/1e3).toFixed(0)),n=e("#end_timeaccess").val();!function(e,t,r,o,a){p({action:"searchadvance",systemroleid:e,courseroleid:t,courseid:r,datestart:o,dateend:a})}(t,r,o,i,parseInt((new Date(n).getTime()/1e3).toFixed(0)))}),e("#resettable").click(function(){e("#username").val(""),e("#useremail").val(""),e("#usercode").val(""),e("#isnotaccess").prop("checked",!1),e("#isnotmodify").prop("checked",!1),e("#userstatus").data("kendoDropDownList").value(-1),e("#system_role").data("kendoDropDownList").value(-1),e("#course_role").data("kendoDropDownList").value(-1),e("#list_course").data("kendoDropDownList").value(-1),e("#start_timeaccess").val(""),e("#end_timeaccess").val(""),p()}),e("#exporttable").on("click",function(t){var r=e(l).find("tr");if(e(r).find(":checkbox").is(":checked")){var o=[{cells:[{value:M.util.get_string("studentname","local_newsvnr")},{value:M.util.get_string("codeuser","local_newsvnr")},{value:M.util.get_string("username_login","local_newsvnr")},{value:M.util.get_string("email","local_newsvnr")},{value:M.util.get_string("createdtime","local_newsvnr")},{value:M.util.get_string("timeaccess","local_newsvnr")},{value:M.util.get_string("lastaccess","local_newsvnr")}]}];exportExcelKendo(l,o)}else e(".k-grid-excel").click()})},deleteUser:function(){e("#btn-user-delete").click(function(){for(var t=getSelectRow("#user_report"),r=JSON.stringify(t),o="",i=0;i<t.length;i++)o+=t[i].name+",";var n={type:"POST",processData:!0,data:{dataselect:r,action:"deleteselected"}};a.confirm("Cảnh báo","Bạn có chắc muốn xóa "+o.slice(0,-1)+" khỏi danh sách người dùng ?",function(){e.ajax(d,n).then(function(t){var r=e.parseJSON(t);a.notify(r.result,"success",3),e(l).data("kendoGrid").dataSource.read(),e(".user-report-fuction").addClass("disabled")})},function(){})})},openPopUp:function(){e(".user-report-fuction").click(function(){var t=e(this).attr("data-href");if(null!=t){var r=e(this).text(),o=getSelectRow("#user_report"),a={type:"POST",processData:!0,data:{dataselect:JSON.stringify(o),action:"addsession"}};e.ajax(d,a).then(function(o){var a='<iframe id="iframe-edit-category" src="'+t+'" width="100%" height="600px" style="border:0"></iframe>';e("#popup-user-report .modal-title").text(r),e("#popup-user-report .modal-body").html(a),e("#iframe-edit-category").on("load",function(){iFrameResize({log:!1},"#iframe-edit-category")})})}})},kendoDropdown:function(){var t="/local/newsvnr/report/ajax/report_data.php?action=";(c={}).apiSettings={url:t+"get_userstatus"},c.value="value",c.optionLabel=M.util.get_string("selectstatus","local_newsvnr");var r=s.initDropDownList(c);e("#userstatus").kendoDropDownList(r),(c={}).apiSettings={url:t+"get_orgstructure_category"},c.value="categoryid",c.optionLabel=M.util.get_string("selectorgstructuretype","local_newsvnr");var o=s.initDropDownList(c);e("#orgstructure_category").kendoDropDownList(o),(c={}).apiSettings={url:t+"get_orgstructure"},c.value="orgid",c.optionLabel=M.util.get_string("selectorgstructure","local_newsvnr"),c.cascadeFrom="orgstructure_category";var a=s.initDropDownList(c);e("#orgstructure").kendoDropDownList(a),(c={}).apiSettings={url:t+"get_orgstructure_jobtitle"},c.value="jobtitleid",c.optionLabel=M.util.get_string("selectjobtitle","local_newsvnr");var i=s.initDropDownList(c);e("#orgstructure_jobtitle").kendoDropDownList(i),(c={}).apiSettings={url:t+"get_orgstructure_position"},c.value="positionid",c.optionLabel=M.util.get_string("selectjobposition","local_newsvnr"),c.cascadeFrom="orgstructure_jobtitle";var n=s.initDropDownList(c);e("#orgstructure_position").kendoDropDownList(n),(c={}).apiSettings={url:t+"get_system_role"},c.value="value",c.optionLabel=M.util.get_string("selectrole","local_newsvnr");var l=s.initDropDownList(c);e("#system_role").kendoDropDownList(l),(c={}).apiSettings={url:t+"get_course_role"},c.value="value",c.optionLabel=M.util.get_string("selectrole","local_newsvnr");var c,u=s.initDropDownList(c);e("#course_role").kendoDropDownList(u),(c={}).apiSettings={url:t+"get_course"},c.value="id",c.optionLabel=M.util.get_string("selectcourse","local_newsvnr");var d=s.initDropDownList(c);e("#list_course").kendoDropDownList(d),e("#start_timeaccess").kendoDatePicker({change:function(){e("#end_timeaccess").val("");var t=e("#start_timeaccess").val().split("/");if(t.length>1){var r=e("#end_timeaccess").data("kendoDatePicker"),o=parseInt(t[2]),a=parseInt(t[0]),i=parseInt(t[1]);r.setOptions({min:new Date(o,a-1,i+1)})}}}),e("#end_timeaccess").kendoDatePicker()}}});