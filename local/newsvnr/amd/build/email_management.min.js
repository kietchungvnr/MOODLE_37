define(["jquery","core/config","local_newsvnr/initkendoexam","alertjs","core/str","core/modal_factory","core/modal_events","core/notification","core/fragment","core/ajax","core/yui","kendo.all.min"],function(t,e,a,i,n,o,l,s,r,d,c,m){"use strict";var u=t("#email_management_grid"),p=e.wwwroot+"/local/newsvnr/ajax/email/emailmanagement.php",f="",g={},_=function(t){_.prototype.init(t)};_.prototype.modal=null,_.prototype.contextid=1,_.prototype.init=function(e){return n.get_string("emailcontentconfig","local_newsvnr").then(function(t){return o.create({type:o.types.SAVE_CANCEL,title:t,body:this.getBody({templateid:e.id})})}.bind(this)).then(function(e){return this.modal=e,this.modal.setLarge(),this.modal.getRoot().on(l.hidden,function(){this.modal.destroy(),m.ui.progress(t("body"),!1)}.bind(this)),this.modal.getRoot().on(l.shown,function(){this.modal.getRoot().append("<style>[data-fieldtype=submit] { display: none ! important; }</style>")}.bind(this)),this.modal.getRoot().on(l.save,this.submitForm.bind(this)),this.modal.getRoot().on("submit","form",this.submitFormAjax.bind(this)),this.modal.show(),this.modal}.bind(this))},_.prototype.getBody=function(t){void 0===t&&(t={});var e={jsonformdata:JSON.stringify(t)};return r.loadFragment("local_newsvnr","create_email_template_form",this.contextid,e)},_.prototype.submitFormAjax=function(e){e.preventDefault();var a=this,n=this.modal.getRoot().find("form").serialize();d.call([{methodname:"local_newsvnr_submit_create_email_template_form",args:{contextid:this.contextid,jsonformdata:JSON.stringify(n)}}])[0].then(function(e){e?(a.modal.hide(),i.success(M.util.get_string("add_success","local_newsvnr"),"success",3),m.ui.progress(t("body"),!1)):a.modal.setBody(this.getBody(e))}).catch(s.exception)},_.prototype.submitForm=function(t){t.preventDefault(),this.modal.getRoot().find("form").submit()};var v=function(e,a){if(null==e.getKendoForm()){e.kendoForm({orientation:"vertical",formData:{templateid:"",name:"",code:"",emailtype:"",description:""},buttonsTemplate:'<button class="k-button k-primary k-form-submit" type="submit" data-action="emailtemplate_add">'+M.util.get_string("addnew","local_newsvnr")+'</button><button class="k-button k-form-clear">'+M.util.get_string("clear","local_newsvnr")+"</button>",items:[{field:"name",label:M.util.get_string("name","local_newsvnr"),validation:{}},{field:"code",label:{text:M.util.get_string("code","local_newsvnr")},validation:{}},{field:"emailtype",label:M.util.get_string("emailtype","local_newsvnr"),validation:{}},{field:"description",label:M.util.get_string("description","local_newsvnr"),editor:function(e,a){t("<textarea class='k-textarea' id='"+a.field+"' name='"+a.field+"' data-bind='value: "+a.field+"'></textarea>").appendTo(e)}}],submit:function(a){if(a.preventDefault(),e.kendoValidator({rules:{ruleRequired:function(e){return!!e.is("[name=description]")||""!==t.trim(e.val())}},messages:{ruleRequired:M.util.get_string("fieldrequired","local_newsvnr")}}).data("kendoValidator").validate()){var n={type:"GET",dataType:"json",contentType:"application/json",data:{action:t("#form-emailtemplate .k-form-submit").attr("data-action"),template:a.model}};t.ajax(p,n).then(function(e){e.success&&(u.data("kendoGrid").dataSource.read(),"emailtemplate_add"==n.data.action&&(t("#name").val(""),t("#code").val(""),t("#emailtype").val(""),t("#description").val("")),i.success(e.success,"success",3))})}else a.preventDefault(),m.ui.progress(t("body"),!1)}})}else"emailtemplate_add"==a?e.getKendoForm().setOptions({buttonsTemplate:'<button class="k-button k-primary k-form-submit" type="submit" data-action="emailtemplate_add">'+M.util.get_string("addnew","local_newsvnr")+'</button><button class="k-button k-form-clear">'+M.util.get_string("clear","local_newsvnr")+"</button>"}):"emailtemplate_edit"==a&&e.getKendoForm().setOptions({buttonsTemplate:'<button class="k-button k-primary k-form-submit" type="submit" data-action="emailtemplate_edit">'+M.util.get_string("edit","local_newsvnr")+'</button><button class="k-button k-form-clear">'+M.util.get_string("clear","local_newsvnr")+"</button>"})};return{initEmailTemplate:function(){var e=t("#form-emailtemplate"),n=t("#modal-emailtemplate"),o=t("#btn-emailtemplate");o.click(function(){n.data("kendoWindow").open(),t("#name").val(""),t("#code").val(""),t("#emailtype").val(""),t("#description").val("")}),n.kendoWindow({width:"450px",title:M.util.get_string("emailcontentconfig","local_newsvnr"),modal:!0,close:function(){f="emailtemplate_add",o.fadeIn()},visible:!1,open:function(t){v(e,f),t.sender.center()}}),n.data("kendoWindow").close();var l=[{field:"name",title:M.util.get_string("name","local_newsvnr"),width:"200px"},{field:"code",title:M.util.get_string("code","local_newsvnr"),width:"150px"},{field:"emailtype",title:M.util.get_string("emailtype","local_newsvnr"),width:"150px"},{field:"description",title:M.util.get_string("description","local_newsvnr"),width:"200px"},{title:M.util.get_string("templateemailconfig","local_newsvnr"),command:{click:function(e){e.preventDefault();var a=this.dataItem(t(e.currentTarget).closest("tr"));m.ui.progress(t("body"),!0),_(a)},name:M.util.get_string("emailcontentconfig","local_newsvnr"),iconClass:"fa fa-paper-plane text-primary mr-1"},width:200}],s={url:p,type:"GET",dataType:"json",contentType:"application/json",data:{action:"emailtemplate_grid"}};g.columns=l,g.apiSettings=s,g.toolbar=["search"],g.editEvent=function(e){console.log(e),f="emailtemplate_edit";var a=t("#form-emailtemplate");v(a,f),a.getKendoForm().setOptions({formData:{templateid:e.id,name:e.name,code:e.code,emailtype:e.emailtype,description:e.description}}),t("#modal-emailtemplate").data("kendoWindow").open()},g.deleteEvent=function(e){var a={type:"GET",dataType:"json",contentType:"application/json; charset=utf-8",data:{action:"emailtemplate_delete",templateid:e.id}};t.ajax(p,a).then(function(t){t.success&&(u.data("kendoGrid").dataSource.read(),i.success(t.success,"success",3))})};var r=a.initGrid(g);u.kendoGrid(r)}}});