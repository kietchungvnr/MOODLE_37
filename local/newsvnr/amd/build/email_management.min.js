define(["jquery","core/config","local_newsvnr/initkendoexam","alertjs","core/str","core/modal_factory","core/modal_events","core/fragment","core/ajax","core/yui","kendo.all.min"],function(t,e,i,a,n,o,l,r,s,d,m){"use strict";var c=t("#email_management_grid"),u=e.wwwroot+"/local/newsvnr/ajax/email/emailmanagement.php",p="",f={},g=function(t){g.prototype.init(t)};g.prototype.modal=null,g.prototype.contextid=1,g.prototype.init=function(e){return n.get_string("emailcontentconfig","local_newsvnr").then(function(t){return o.create({type:o.types.SAVE_CANCEL,title:t,body:this.getBody({templateid:e.id})})}.bind(this)).then(function(e){return this.modal=e,this.modal.setLarge(),this.modal.getRoot().on(l.hidden,function(){this.modal.destroy()}.bind(this)),this.modal.getRoot().on(l.shown,function(){this.modal.getRoot().append("<style>[data-fieldtype=submit] { display: none ! important; }</style>")}.bind(this)),this.modal.getRoot().on(l.save,this.submitForm.bind(this)),this.modal.getRoot().on("submit","form",this.submitFormAjax.bind(this)),m.ui.progress(t("body"),!1),this.modal.show(),this.modal}.bind(this))},g.prototype.getBody=function(t){void 0===t&&(t={});var e={jsonformdata:JSON.stringify(t)};return r.loadFragment("local_newsvnr","create_email_template_form",this.contextid,e)},g.prototype.handleFormSubmissionResponse=function(){this.modal.hide(),d.use("moodle-core-formchangechecker",function(){M.core_formchangechecker.reset_form_dirty_state()})},g.prototype.handleFormSubmissionFailure=function(t){this.modal.setBody(this.getBody(t))},g.prototype.submitFormAjax=function(t){t.preventDefault();var e=this.modal.getRoot().find("form").serialize();s.call([{methodname:"local_newsvnr_submit_create_email_template_form",args:{contextid:this.contextid,jsonformdata:JSON.stringify(e)},done:this.handleFormSubmissionResponse.bind(this,e),fail:this.handleFormSubmissionFailure.bind(this,e)}])},g.prototype.submitForm=function(t){t.preventDefault(),this.modal.getRoot().find("form").submit()};var _=function(e,i){if(null==e.getKendoForm()){e.kendoForm({orientation:"vertical",formData:{templateid:"",name:"",code:"",emailtype:"",description:""},buttonsTemplate:'<button class="k-button k-primary k-form-submit" type="submit" data-action="emailtemplate_add">'+M.util.get_string("addnew","local_newsvnr")+'</button><button class="k-button k-form-clear">'+M.util.get_string("clear","local_newsvnr")+"</button>",items:[{field:"name",label:M.util.get_string("name","local_newsvnr"),validation:{}},{field:"code",label:{text:M.util.get_string("code","local_newsvnr")},validation:{}},{field:"emailtype",label:M.util.get_string("emailtype","local_newsvnr"),validation:{}},{field:"description",label:M.util.get_string("description","local_newsvnr"),editor:function(e,i){t("<textarea class='k-textarea' id='"+i.field+"' name='"+i.field+"' data-bind='value: "+i.field+"'></textarea>").appendTo(e)}}],submit:function(i){if(i.preventDefault(),e.kendoValidator({rules:{ruleRequired:function(e){return!!e.is("[name=description]")||""!==t.trim(e.val())}},messages:{ruleRequired:M.util.get_string("fieldrequired","local_newsvnr")}}).data("kendoValidator").validate()){var n={type:"GET",dataType:"json",contentType:"application/json",data:{action:t("#form-emailtemplate .k-form-submit").attr("data-action"),template:i.model}};t.ajax(u,n).then(function(e){e.success&&(c.data("kendoGrid").dataSource.read(),"emailtemplate_add"==n.data.action&&(t("#name").val(""),t("#code").val(""),t("#emailtype").val(""),t("#description").val("")),a.success(e.success,"success",3))})}else i.preventDefault(),m.ui.progress(t("body"),!1)}})}else"emailtemplate_add"==i?e.getKendoForm().setOptions({buttonsTemplate:'<button class="k-button k-primary k-form-submit" type="submit" data-action="emailtemplate_add">'+M.util.get_string("addnew","local_newsvnr")+'</button><button class="k-button k-form-clear">'+M.util.get_string("clear","local_newsvnr")+"</button>"}):"emailtemplate_edit"==i&&e.getKendoForm().setOptions({buttonsTemplate:'<button class="k-button k-primary k-form-submit" type="submit" data-action="emailtemplate_edit">'+M.util.get_string("edit","local_newsvnr")+'</button><button class="k-button k-form-clear">'+M.util.get_string("clear","local_newsvnr")+"</button>"})};return{initEmailTemplate:function(){var e=t("#form-emailtemplate"),n=t("#modal-emailtemplate"),o=t("#btn-emailtemplate");o.click(function(){n.data("kendoWindow").open(),t("#name").val(""),t("#code").val(""),t("#emailtype").val(""),t("#description").val("")}),n.kendoWindow({width:"450px",title:M.util.get_string("emailcontentconfig","local_newsvnr"),modal:!0,close:function(){p="emailtemplate_add",o.fadeIn()},visible:!1,open:function(t){_(e,p),t.sender.center()}}),n.data("kendoWindow").close();var l=[{field:"name",title:M.util.get_string("name","local_newsvnr"),width:"200px"},{field:"code",title:M.util.get_string("code","local_newsvnr"),width:"150px"},{field:"emailtype",title:M.util.get_string("emailtype","local_newsvnr"),width:"150px"},{field:"description",title:M.util.get_string("description","local_newsvnr"),width:"200px"},{title:M.util.get_string("templateemailconfig","local_newsvnr"),command:{click:function(e){e.preventDefault();var i=this.dataItem(t(e.currentTarget).closest("tr"));m.ui.progress(t("body"),!0),g(i)},name:M.util.get_string("emailcontentconfig","local_newsvnr"),iconClass:"fa fa-paper-plane text-primary mr-1"},width:200}],r={url:u,type:"GET",dataType:"json",contentType:"application/json",data:{action:"emailtemplate_grid"}};f.columns=l,f.apiSettings=r,f.toolbar=["search"],f.editEvent=function(e){console.log(e),p="emailtemplate_edit";var i=t("#form-emailtemplate");_(i,p),i.getKendoForm().setOptions({formData:{templateid:e.id,name:e.name,code:e.code,emailtype:e.emailtype,description:e.description}}),t("#modal-emailtemplate").data("kendoWindow").open()},f.deleteEvent=function(e){var i={type:"GET",dataType:"json",contentType:"application/json; charset=utf-8",data:{action:"emailtemplate_delete",templateid:e.id}};t.ajax(u,i).then(function(t){t.success&&(c.data("kendoGrid").dataSource.read(),a.success(t.success,"success",3))})};var s=i.initGrid(f);c.kendoGrid(s)}}});